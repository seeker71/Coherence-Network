name = "coherence-network"
description = "Coherence Network enforced worktree delivery environment"
workspace_root = "/Users/ursmuff/source/Coherence-Network"

[setup]
required = true
script = 'if gh auth status >/dev/null 2>&1; then START_GATE_ENFORCE_REMOTE_FAILURES=0 make start-gate; else START_GATE_REQUIRE_GH=0 make start-gate; fi'

[validation.local]
commands = [
  "python3 scripts/worktree_pr_guard.py --mode local --base-ref origin/main",
  "python3 scripts/check_pr_followthrough.py --stale-minutes 90 --fail-on-stale --strict",
  "./scripts/verify_worktree_local_web.sh"
]

[validation.gates]
commands = [
  "python3 scripts/validate_commit_evidence.py --base origin/main --head HEAD --require-changed-evidence",
  "python3 scripts/validate_spec_quality.py --base origin/main --head HEAD",
  "python3 scripts/validate_workflow_references.py"
]

[validation.api]
commands = [
  "cd api && .venv/bin/pytest -v",
  "cd api && .venv/bin/pytest -v --ignore=tests/holdout"
]

[validation.web]
commands = [
  "cd web && npm ci",
  "cd web && npm run build"
]

[validation.pipeline]
commands = [
  "cd api && .venv/bin/python scripts/check_pipeline.py --json",
  "cd api && ./scripts/ensure_effective_pipeline.sh"
]

[validation.deploy]
commands = [
  "./scripts/verify_full_deployment.sh",
  "./scripts/verify_web_api_deploy.sh"
]

[policy]
finished_definition = "A task is finished only after start gate, local gates, CI checks, deployment, and successful public verification."
