name: Claude Code Host Runner Task

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: "Task for Claude Code to implement"
        required: false
        default: |
          Replace the runtime placeholder in api/app/models/coherence.py.

          The field `components_with_data` has description: "rest are 0.5 stub (spec 020 data confidence)".
          This is a tracked placeholder — spec 020 documents that non-data components default to 0.5.

          Your task:
          1. Update the field description to remove the stub language — replace with clear production
             documentation: "Number of components with real computed scores; others default to 0.5."
          2. Add a class-level docstring note that components_with_data is set by the coherence
             algorithm and 0.5 is the neutral prior for uncomputed components (not a stub).
          3. Run: python3 -m pytest api/tests/ -x -q --tb=short 2>&1 | tail -5
          4. Show the final diff of the changed file.
          5. Do NOT commit anything.

jobs:
  claude-code-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up Node.js (for Claude Code CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Verify claude CLI and auth
        run: |
          which claude
          claude --version
          CLAUDECODE= claude auth status --json

      - name: Install API dependencies
        run: cd api && pip install -e ".[dev]"

      - name: Write task to file
        run: |
          cat > /tmp/claude_task.txt << 'TASKEOF'
          Replace the runtime placeholder in api/app/models/coherence.py.

          The field components_with_data has description text that ends with "rest are 0.5 stub (spec 020 data confidence)".
          This is a tracked placeholder. Spec 020 documents that non-data components default to 0.5.

          Your task:
          1. Update the field description to remove the stub language. New description:
             "Number of components with real computed scores; others default to 0.5 (neutral prior)."
          2. Update the class docstring to note that 0.5 is the neutral prior for uncomputed components, not a stub.
          3. Run tests: cd api && python3 -m pytest tests/ -x -q --tb=short 2>&1 | tail -8
          4. Show the final git diff of the changed file.
          5. Do NOT commit anything.
          TASKEOF
          echo "=== Task written to /tmp/claude_task.txt ==="
          cat /tmp/claude_task.txt

      - name: Run task with Claude Code
        id: claude_task
        run: |
          echo "=== Running claude -p ==="
          claude -p "$(cat /tmp/claude_task.txt)" \
            --dangerously-skip-permissions \
            --output-format text 2>&1
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
