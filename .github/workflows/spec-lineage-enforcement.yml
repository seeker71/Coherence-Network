name: Spec Lineage Enforcement

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'specs/**/*.md'

jobs:
  validate-lineage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Validate spec lineage
        id: validate
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          chmod +x scripts/validate_spec_lineage.py
          python3 scripts/validate_spec_lineage.py \
            --base "$BASE_SHA" \
            --head "$HEAD_SHA" \
            --json > lineage_report.json || true

          cat lineage_report.json

          result=$(jq -r '.result' lineage_report.json)
          reason=$(jq -r '.reason' lineage_report.json)
          missing=$(jq -r '.stats.specs_missing_lineage' lineage_report.json)
          incomplete=$(jq -r '.stats.specs_incomplete_lineage' lineage_report.json)

          echo "result=$result" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"
          echo "missing=$missing" >> "$GITHUB_OUTPUT"
          echo "incomplete=$incomplete" >> "$GITHUB_OUTPUT"

      - name: Auto-create lineage from PR metadata
        if: steps.validate.outputs.result == 'fail' && steps.validate.outputs.missing > 0
        id: auto_create
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Extract list of specs missing lineage
          MISSING_SPECS=$(jq -r '.missing_lineage[].spec_path' lineage_report.json | tr '\n' ' ')

          if [ -n "$MISSING_SPECS" ]; then
            echo "Attempting to auto-create lineage for: $MISSING_SPECS"

            # Note: API not available in CI, so we'll just generate the data
            # In production, this would call the API or commit the lineage file
            chmod +x scripts/auto_create_lineage.py scripts/extract_spec_metadata.py

            python3 scripts/auto_create_lineage.py \
              --specs $MISSING_SPECS \
              --pr-number "$PR_NUMBER" \
              --pr-author "$PR_AUTHOR" \
              --dry-run \
              --json > auto_lineage_report.json || true

            cat auto_lineage_report.json

            # Check results
            created=$(jq -r '.summary.created' auto_lineage_report.json)
            needs_idea=$(jq -r '.summary.needs_idea_id' auto_lineage_report.json)

            echo "auto_created=$created" >> "$GITHUB_OUTPUT"
            echo "needs_idea_id=$needs_idea" >> "$GITHUB_OUTPUT"

            # If we successfully identified all metadata, report success
            if [ "$needs_idea_id" = "0" ]; then
              echo "‚úÖ Auto-created lineage data for all specs"
              echo "auto_success=true" >> "$GITHUB_OUTPUT"
            else
              echo "‚ö†Ô∏è  Some specs need manual idea_id annotation"
              echo "auto_success=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Re-validate after auto-creation
        if: steps.auto_create.outputs.auto_success == 'true'
        run: |
          echo "Re-validating lineage after auto-creation..."
          # In production, this would re-run validation
          # For now, we'll assume success if auto-creation succeeded
          echo "‚úÖ Lineage auto-created successfully"

      - name: Comment on PR (if validation fails)
        if: steps.validate.outputs.result == 'fail' && steps.auto_create.outputs.auto_success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('lineage_report.json', 'utf8'));

            let comment = '## ‚ö†Ô∏è  Spec Lineage Needs Attention\n\n';

            // Check if auto-creation was attempted
            let autoReport = null;
            try {
              autoReport = JSON.parse(fs.readFileSync('auto_lineage_report.json', 'utf8'));
            } catch (e) {
              // No auto-creation report
            }

            if (autoReport && autoReport.missing_idea_ids.length > 0) {
              comment += '### ü§ñ Auto-Creation Attempted\n\n';
              comment += 'I tried to auto-create lineage from PR metadata, but some specs are missing **Idea** annotations:\n\n';
              for (const item of autoReport.missing_idea_ids) {
                comment += `- \`${item.spec_path}\`\n`;
              }
              comment += '\n**Quick Fix**: Add this to each spec:\n';
              comment += '```markdown\n';
              comment += '**Idea**: `your-idea-id`\n';
              comment += '```\n\n';
              comment += 'Then the system will auto-create lineage for you! ‚ú®\n\n';
            } else {
              comment += `**Reason**: ${report.reason}\n\n`;
            }

            if (report.missing_lineage.length > 0) {
              comment += '### Missing Lineage\n\n';
              comment += 'The following specs were modified but have no value-lineage link:\n\n';
              for (const item of report.missing_lineage) {
                comment += `- \`${item.spec_path}\` (spec_id: \`${item.spec_id}\`)\n`;
              }
              comment += '\n';
            }

            if (report.incomplete_lineage.length > 0) {
              comment += '### Incomplete Lineage\n\n';
              comment += 'The following specs have lineage links but are missing required fields:\n\n';
              for (const item of report.incomplete_lineage) {
                comment += `- \`${item.spec_path}\` (spec_id: \`${item.spec_id}\`)\n`;
                for (const error of item.errors) {
                  comment += `  - ${error}\n`;
                }
              }
              comment += '\n';
            }

            comment += '### üîß How to Fix\n\n';
            comment += 'Create or update value-lineage links via the API:\n\n';
            comment += '```bash\n';
            comment += 'curl -X POST http://localhost:8000/api/value-lineage/links \\\n';
            comment += '  -H "Content-Type: application/json" \\\n';
            comment += '  -d \'{\n';
            comment += '    "idea_id": "<idea-id>",\n';
            comment += '    "spec_id": "<spec-id>",\n';
            comment += '    "implementation_refs": ["PR#' + context.issue.number + '"],\n';
            comment += '    "contributors": {\n';
            comment += '      "idea": "' + context.payload.pull_request.user.login + '",\n';
            comment += '      "spec": "' + context.payload.pull_request.user.login + '",\n';
            comment += '      "implementation": "' + context.payload.pull_request.user.login + '",\n';
            comment += '      "review": "<reviewer-github-username>"\n';
            comment += '    },\n';
            comment += '    "estimated_cost": <hours>\n';
            comment += '  }\'\n';
            comment += '```\n\n';
            comment += '**Spec Reference**: [061-traceability-maturity-governance](https://github.com/seeker71/Coherence-Network/blob/main/specs/061-traceability-maturity-governance.md)\n\n';
            comment += '**Idea**: `traceability-maturity-governance` - Strengthen end-to-end tracking for autonomous evolution\n\n';
            comment += '---\n';
            comment += '_This check enforces merge-time lineage for spec changes. All specs must be traceable to ideas for machine reasoning._';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail if lineage invalid
        if: steps.validate.outputs.result == 'fail'
        run: |
          echo "‚ùå Spec lineage validation failed"
          echo "Missing lineage: ${{ steps.validate.outputs.missing }}"
          echo "Incomplete lineage: ${{ steps.validate.outputs.incomplete }}"
          echo ""
          echo "See PR comment for details on how to fix."
          exit 1

      - name: Success comment
        if: steps.validate.outputs.result == 'pass'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '## ‚úÖ Spec Lineage Validation Passed\n\nAll modified specs have complete value-lineage links with:\n- Idea traceability\n- Complete contributor attribution\n- Implementation references\n\n_Traceability enforcement active - enabling autonomous evolution._';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
