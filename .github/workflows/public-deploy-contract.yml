name: Public Deploy Contract

on:
  push:
    branches: [main]
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

concurrency:
  group: public-deploy-contract-main
  cancel-in-progress: true

jobs:
  validate-public-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: write
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT }}
      RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE }}
      PUBLIC_DEPLOY_VERIFICATION_MAX_ATTEMPTS: 8
      PUBLIC_DEPLOY_VERIFICATION_RETRY_SECONDS: 60
      PUBLIC_DEPLOY_CONTRACT_BLOCK_THRESHOLD_SECONDS: 600
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up Node.js (Railway CLI runtime)
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install API dependencies
        run: |
          cd api && pip install -e ".[dev]"

      - name: Validate public deployment contract
        id: validate
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set +e
          cd api
          python scripts/validate_public_deploy_contract.py \
            --repo "${{ github.repository }}" \
            --branch main \
            --json > ../public_deploy_contract_report.json
          code=$?
          cd ..
          cat public_deploy_contract_report.json
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Install Railway CLI
        if: ${{ steps.validate.outputs.exit_code != '0' }}
        run: |
          if [ -z "${RAILWAY_TOKEN:-}" ]; then
            echo "RAILWAY_TOKEN not configured, skipping CLI install."
            exit 0
          fi
          npm install -g @railway/cli

      - name: Trigger Railway redeploy
        id: railway_redeploy
        if: ${{ steps.validate.outputs.exit_code != '0' }}
        run: |
          set +e
          if [ -z "${RAILWAY_TOKEN:-}" ] || [ -z "${RAILWAY_PROJECT_ID:-}" ] || [ -z "${RAILWAY_ENVIRONMENT:-}" ] || [ -z "${RAILWAY_SERVICE:-}" ]; then
            echo "attempted=false" >> "$GITHUB_OUTPUT"
            echo "reason=missing_railway_context_secrets" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          railway link --project "$RAILWAY_PROJECT_ID" --environment "$RAILWAY_ENVIRONMENT" --service "$RAILWAY_SERVICE" --json > railway_link.json
          railway redeploy --service "$RAILWAY_SERVICE" --yes --json > railway_redeploy.json
          cat railway_redeploy.json
          echo "attempted=true" >> "$GITHUB_OUTPUT"
          echo "reason=redeploy_triggered" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Re-validate after Railway redeploy
        id: revalidate
        if: ${{ steps.validate.outputs.exit_code != '0' && steps.railway_redeploy.outputs.attempted == 'true' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          PUBLIC_DEPLOY_VERIFICATION_MAX_ATTEMPTS: ${{ vars.PUBLIC_DEPLOY_VERIFICATION_MAX_ATTEMPTS || vars.PUBLIC_DEPLOY_REVALIDATE_MAX_ATTEMPTS || '8' }}
          PUBLIC_DEPLOY_VERIFICATION_RETRY_SECONDS: ${{ vars.PUBLIC_DEPLOY_VERIFICATION_RETRY_SECONDS || vars.PUBLIC_DEPLOY_REVALIDATE_SLEEP_SECONDS || '60' }}
        run: |
          set +e
          code=2
          previous_fail_sig=""
          unchanged_fail_count=0
          max_attempts="${PUBLIC_DEPLOY_VERIFICATION_MAX_ATTEMPTS:-8}"
          sleep_seconds="${PUBLIC_DEPLOY_VERIFICATION_RETRY_SECONDS:-60}"

          for i in $(seq 1 "$max_attempts"); do
            cd api
            python scripts/validate_public_deploy_contract.py \
              --repo "${{ github.repository }}" \
              --branch main \
              --json > ../public_deploy_contract_report.json
            code=$?
            cd ..
            cat public_deploy_contract_report.json
            if [ "$code" -eq 0 ]; then
              break
            fi

            fail_sig="$(jq -c '.failing_checks // []' public_deploy_contract_report.json)"
            if [ "$fail_sig" = "$previous_fail_sig" ]; then
              unchanged_fail_count=$((unchanged_fail_count + 1))
            else
              unchanged_fail_count=1
              previous_fail_sig="$fail_sig"
            fi

            if [ "$unchanged_fail_count" -ge 4 ]; then
              echo "Fail-fast: failing_checks stable for 4 attempts (${fail_sig})."
              break
            fi

            sleep "$sleep_seconds"
          done
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Select effective contract result
        id: outcome
        run: |
          final="${{ steps.validate.outputs.exit_code }}"
          if [ -n "${{ steps.revalidate.outputs.exit_code }}" ]; then
            final="${{ steps.revalidate.outputs.exit_code }}"
          fi
          echo "exit_code=$final" >> "$GITHUB_OUTPUT"
          echo "initial_exit_code=${{ steps.validate.outputs.exit_code }}" >> "$GITHUB_OUTPUT"
          echo "revalidated_exit_code=${{ steps.revalidate.outputs.exit_code }}" >> "$GITHUB_OUTPUT"

      - name: Upload public deploy report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: public_deploy_contract_report_${{ github.sha }}
          path: public_deploy_contract_report.json

      - name: Upload Railway redeploy artifacts
        if: ${{ always() && steps.railway_redeploy.outputs.attempted == 'true' }}
        uses: actions/upload-artifact@v6
        with:
          name: railway_redeploy_artifacts_${{ github.sha }}
          path: |
            railway_link.json
            railway_redeploy.json

      - name: Create or update deploy drift issue
        if: ${{ steps.outcome.outputs.exit_code != '0' }}
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('public_deploy_contract_report.json', 'utf8'));
            const title = 'Public deployment contract failing on main';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              'Automated check detected public deployment drift.',
              '',
              `- Workflow run: ${runUrl}`,
              `- Expected SHA: \`${report.expected_sha || 'unknown'}\``,
              `- Result: \`${report.result || 'blocked'}\``,
              `- Reason: ${report.reason || 'n/a'}`,
              `- Initial exit code: \`${"${{ steps.outcome.outputs.initial_exit_code }}"}\``,
              `- Revalidated exit code: \`${"${{ steps.outcome.outputs.revalidated_exit_code }}"}\``,
              `- Railway redeploy attempted: \`${"${{ steps.railway_redeploy.outputs.attempted || 'false' }}"}\``,
              `- Railway redeploy note: \`${"${{ steps.railway_redeploy.outputs.reason || 'n/a' }}"}\``,
              '',
              'Failing checks:',
              ...(Array.isArray(report.failing_checks) && report.failing_checks.length
                ? report.failing_checks.map((x) => `- \`${x}\``)
                : ['- (none reported)']),
              '',
              'Raw report:',
              '```json',
              JSON.stringify(report, null, 2).slice(0, 6000),
              '```',
            ].join('\n');

            const query = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${title}"`;
            const existing = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1 });
            if (existing.data.items.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data.items[0].number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
              });
            }

      - name: Resolve deploy drift issue when contract passes
        if: ${{ steps.outcome.outputs.exit_code == '0' }}
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'Public deployment contract failing on main';
            const query = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${title}"`;
            const existing = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1 });
            if (existing.data.items.length === 0) {
              return;
            }
            const issue = existing.data.items[0];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Resolved by workflow run ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}. Public deployment contract is now passing.`,
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
            });

      - name: Dispatch auto-heal workflow
        if: ${{ steps.outcome.outputs.exit_code != '0' && github.event_name == 'push' && vars.AUTO_HEAL_DEPLOY_GATES_ENABLED == '1' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          curl -sS -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/auto-heal-deploy-gates.yml/dispatches" \
            -d '{"ref":"main","inputs":{"sha":"${{ github.sha }}"}}'

      - name: Fail when contract is not satisfied
        if: ${{ steps.outcome.outputs.exit_code != '0' && github.event_name != 'schedule' }}
        run: |
          echo "Public deployment contract failed"
          exit 1
