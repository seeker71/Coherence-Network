name: Provider Readiness Contract

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      strict:
        description: "Fail the workflow when blocking readiness issues exist (default is non-blocking; issue is the alert)."
        required: false
        default: "false"

jobs:
  validate-provider-readiness:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    env:
      OPENAI_ADMIN_API_KEY: ${{ secrets.OPENAI_ADMIN_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN_READINESS }}
      GITHUB_BILLING_OWNER: ${{ vars.GITHUB_BILLING_OWNER }}
      GITHUB_BILLING_SCOPE: ${{ vars.GITHUB_BILLING_SCOPE }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
      CURSOR_CLI_MODEL: ${{ vars.CURSOR_CLI_MODEL }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_ENVIRONMENT: ${{ secrets.RAILWAY_ENVIRONMENT }}
      RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE }}
      AUTOMATION_REQUIRED_PROVIDERS: ${{ vars.AUTOMATION_REQUIRED_PROVIDERS }}
      AUTOMATION_PROVIDER_VALIDATION_REQUIRED: ${{ vars.AUTOMATION_PROVIDER_VALIDATION_REQUIRED }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up Node.js (for Claude Code CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Install API dependencies
        run: |
          cd api && pip install -e ".[dev]"

      - name: Check provider readiness
        id: readiness
        run: |
          set +e
          cd api
          REQUIRED="${AUTOMATION_PROVIDER_VALIDATION_REQUIRED:-$AUTOMATION_REQUIRED_PROVIDERS}"
          if [ -z "${REQUIRED// /}" ]; then
            # Keep the contract meaningful even when repo variables are unset.
            # Default to providers that are expected to be configured in CI.
            REQUIRED="coherence-internal,github,railway,claude-code"
          fi
          python scripts/check_provider_readiness.py \
            --required-providers "$REQUIRED" \
            --run-auto-heal \
            --heal-rounds 2 \
            --run-probes \
            --json \
            --fail-on-blocking > ../provider_readiness_report.json
          code=$?
          cd ..
          cat provider_readiness_report.json
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload provider readiness report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: provider_readiness_report_${{ github.sha }}
          path: provider_readiness_report.json

      - name: Create or update provider readiness issue
        if: ${{ steps.readiness.outputs.exit_code != '0' }}
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('provider_readiness_report.json', 'utf8'));
            const readiness = report.readiness || {};
            const validation = report.validation || {};
            const title = 'Provider readiness contract failing';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              'Automated provider readiness contract detected blocking issues.',
              '',
              `- Workflow run: ${runUrl}`,
              `- all_required_ready: ${readiness.all_required_ready}`,
              `- all_required_validated: ${validation.all_required_validated}`,
              `- required_providers: ${(validation.required_providers || []).join(', ')}`,
              '',
              'Blocking issues:',
              ...((validation.blocking_issues || []).length
                ? validation.blocking_issues.map((x) => `- ${x}`)
                : ['- (none reported)']),
              '',
              'Readiness recommendations:',
              ...((readiness.recommendations || []).length
                ? readiness.recommendations.map((x) => `- ${x}`)
                : ['- (none)']),
              '',
              'Raw report:',
              '```json',
              JSON.stringify(report, null, 2).slice(0, 6000),
              '```',
            ].join('\n');

            const query = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${title}"`;
            const existing = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1 });
            if (existing.data.items.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data.items[0].number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
              });
            }

      - name: Resolve provider readiness issue when contract passes
        if: ${{ steps.readiness.outputs.exit_code == '0' }}
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'Provider readiness contract failing';
            const query = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open in:title "${title}"`;
            const existing = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1 });
            if (existing.data.items.length === 0) {
              return;
            }
            const issue = existing.data.items[0];
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Resolved by workflow run ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}. Provider readiness contract is now passing.`,
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
            });

      - name: Fail when blocking provider readiness issues exist
        # This workflow is non-blocking by default; use workflow_dispatch with strict=true to make it fail.
        if: ${{ github.event_name == 'workflow_dispatch' && steps.readiness.outputs.exit_code != '0' && inputs.strict == 'true' }}
        run: |
          echo "Provider readiness contract failed"
          exit 1

      - name: Non-blocking by default (issue is the alert)
        if: ${{ steps.readiness.outputs.exit_code != '0' && !(github.event_name == 'workflow_dispatch' && inputs.strict == 'true') }}
        run: |
          echo "WARNING: Provider readiness contract detected issues, but this run is non-blocking (run via workflow_dispatch with strict=true to fail)."
          exit 0
